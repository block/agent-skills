name: Validate Skills

on:
  pull_request:
    paths:
      - "**"
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Determine changed skill directories
        id: changed
        shell: bash
        run: |
          set -euo pipefail

          IGNORE_DIRS_REGEX='^(\.git|\.github|scripts|node_modules)(/|$)'

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE="${{ github.event.pull_request.base.sha }}"
            HEAD="${{ github.event.pull_request.head.sha }}"
            CHANGED_FILES="$(git diff --name-only --diff-filter=AM "$BASE..$HEAD" || true)"
          else
            BEFORE="${{ github.event.before }}"
            AFTER="${{ github.event.after }}"
            CHANGED_FILES="$(git diff --name-only --diff-filter=AM "$BEFORE..$AFTER" || true)"
          fi

          # Top-level dirs only (skills are top-level folders)
          SKILL_DIRS="$(echo "$CHANGED_FILES" \
            | awk -F/ 'NF>1 {print $1}' \
            | grep -Ev "$IGNORE_DIRS_REGEX" \
            | sort -u \
            | tr '\n' ',' \
            | sed 's/,$//' \
            || true
          )"

          echo "changed_skills=$SKILL_DIRS" >> "$GITHUB_OUTPUT"

          if [ -z "$SKILL_DIRS" ]; then
            echo "No changed skill directories detected."
          else
            echo "Changed skill dirs: $SKILL_DIRS"
          fi


      # Always ensure a report file exists so downstream steps are stable.
      - name: Initialize validation report file
        shell: bash
        env:
          SKILLS_VALIDATION_REPORT: ${{ runner.temp }}/skills-validation-report.json
        run: |
          set -euo pipefail
          cat > "$SKILLS_VALIDATION_REPORT" <<'JSON'
          {
            "scanned_skills": [],
            "summary": { "fail_count": 0, "warn_count": 0, "status": "PASSED" },
            "findings": [],
            "timestamp": ""
          }
          JSON

      - name: Validate changed skills only
        id: validate
        if: steps.changed.outputs.changed_skills != ''
        env:
          SKILLS_VALIDATION_REPORT: ${{ runner.temp }}/skills-validation-report.json
        run: |
          node scripts/validate-skills.mjs \
            --skills "${{ steps.changed.outputs.changed_skills }}" \
            --report "${SKILLS_VALIDATION_REPORT}"

      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: skills-validation-report
          path: |
            ${{ runner.temp }}/skills-validation-report.json
          if-no-files-found: error
          retention-days: 10

      # Label ONLY when WARN/FAIL. Also remove it when clean.
      - name: Update security-review-required label based on report
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          REPORT_PATH: ${{ runner.temp }}/skills-validation-report.json
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require("fs");
            const label = "security-review-required";
            const reportPath = process.env.REPORT_PATH;

            if (!fs.existsSync(reportPath)) {
              core.setFailed(`Expected report at ${reportPath} but it was not found.`);
              return;
            }

            const report = JSON.parse(fs.readFileSync(reportPath, "utf8"));
            const warn = report?.summary?.warn_count ?? 0;
            const fail = report?.summary?.fail_count ?? 0;

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.pull_request.number;

            const shouldHaveLabel = (warn > 0 || fail > 0);

            // Fetch current labels to make add/remove idempotent
            const { data: existing } = await github.rest.issues.listLabelsOnIssue({
              owner, repo, issue_number, per_page: 100
            });
            const hasLabel = existing.some(l => l.name === label);

            if (shouldHaveLabel && !hasLabel) {
              core.info(`Applying "${label}" (warn=${warn}, fail=${fail})`);
              await github.rest.issues.addLabels({
                owner, repo, issue_number,
                labels: [label],
              });
            } else if (!shouldHaveLabel && hasLabel) {
              core.info(`Removing "${label}" (warn=${warn}, fail=${fail})`);
              await github.rest.issues.removeLabel({
                owner, repo, issue_number,
                name: label,
              });
            } else {
              core.info(`No label change needed. hasLabel=${hasLabel} warn=${warn} fail=${fail}`);
            }
